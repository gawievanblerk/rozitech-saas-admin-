name: Deploy with Verification

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'website_pages/**'
      - '.github/workflows/deploy-with-verification.yml'

jobs:
  verify-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add known hosts if provided
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
          fi
      
      - name: Verify SSH Connection
        run: |
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.SSH_PORT || '22' }} \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
              "echo 'SSH connection successful'"
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ SSH connection verified"
          else
            echo "‚ùå SSH connection failed"
            exit 1
          fi
      
      - name: Deploy Website Files
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          timeout: 60s
          script: |
            echo "üöÄ Starting Website Deployment..."
            
            # First, let's discover the directory structure
            echo "üìÇ Discovering directory structure..."
            echo "Current user: $(whoami)"
            echo "Home directory: $HOME"
            
            # Check common Xneelo/cPanel paths
            echo "Checking for web directories..."
            
            # List current home directory contents
            echo "Current home directory contents:"
            ls -la $HOME
            
            # Check if public_html exists, if not create it
            if [ -d "$HOME/public_html" ]; then
              echo "‚úÖ Found existing: $HOME/public_html"
              WEB_ROOT="$HOME/public_html"
            elif [ -d "$HOME/www" ]; then
              echo "‚úÖ Found existing: $HOME/www"
              WEB_ROOT="$HOME/www"
            elif [ -d "$HOME/htdocs" ]; then
              echo "‚úÖ Found existing: $HOME/htdocs"
              WEB_ROOT="$HOME/htdocs"
            else
              # Create public_html directory since it doesn't exist
              echo "üìÅ Web directory not found. Creating public_html..."
              mkdir -p "$HOME/public_html"
              if [ $? -eq 0 ]; then
                echo "‚úÖ Successfully created $HOME/public_html"
                WEB_ROOT="$HOME/public_html"
                
                # Create a simple .htaccess file for Apache
                echo "Creating .htaccess file..."
                cat > "$HOME/public_html/.htaccess" << 'HTACCESS'
            # Basic Apache configuration
            Options -Indexes
            DirectoryIndex index.html index.php
            
            # Enable compression
            <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript
            </IfModule>
            HTACCESS
                echo "‚úÖ Created .htaccess file"
              else
                echo "‚ùå Failed to create public_html directory"
                echo "Trying alternative location..."
                
                # Try creating in current directory
                mkdir -p "./www"
                if [ $? -eq 0 ]; then
                  echo "‚úÖ Created www directory in current location"
                  WEB_ROOT="$(pwd)/www"
                else
                  echo "‚ùå Could not create web directory"
                  exit 1
                fi
              fi
            fi
            
            echo "üìÇ Using web root: $WEB_ROOT"
            
            # Check what's currently in the web root
            echo "Current files in web root:"
            ls -la "$WEB_ROOT" | head -20
            
            # Check for other potential web directories
            echo ""
            echo "üîç Checking for other web directories..."
            
            # Check if there's a domains directory (common in cPanel/Xneelo)
            if [ -d "$HOME/domains" ]; then
              echo "Found domains directory:"
              ls -la "$HOME/domains"
              
              # Check each domain folder
              for domain in $HOME/domains/*/; do
                if [ -d "$domain" ]; then
                  echo "Domain: $domain"
                  if [ -d "$domain/public_html" ]; then
                    echo "  ‚Üí Has public_html:"
                    ls -la "$domain/public_html" | head -5
                  fi
                fi
              done
            fi
            
            # Check for www directory
            if [ -d "$HOME/www" ] && [ "$WEB_ROOT" != "$HOME/www" ]; then
              echo "Found www directory:"
              ls -la "$HOME/www" | head -5
            fi
            
            # Check Apache/Nginx config if accessible
            if [ -f "/etc/apache2/sites-enabled/000-default.conf" ]; then
              echo "Apache config DocumentRoot:"
              grep -i documentroot /etc/apache2/sites-enabled/000-default.conf 2>/dev/null | head -2
            fi
            
            # Check if there's a symbolic link
            if [ -L "$HOME/public_html" ]; then
              echo "‚ö†Ô∏è public_html is a symbolic link pointing to:"
              readlink -f "$HOME/public_html"
            fi
            
            # Find all index.html files in home directory
            echo ""
            echo "üîç Finding all index.html files:"
            find $HOME -name "index.html" -type f 2>/dev/null | head -10
            
            # Backup existing index.html if it exists
            if [ -f "$WEB_ROOT/index.html" ]; then
              echo "üì¶ Backing up existing index.html"
              cp "$WEB_ROOT/index.html" "$WEB_ROOT/index.html.backup.$(date +%s)"
            fi
            
            # Create temp directory
            TEMP_DIR="/tmp/rozitech-deploy-$(date +%s)"
            mkdir -p "$TEMP_DIR"
            cd "$TEMP_DIR"
            
            # Create index.html
            cat > index.html << 'EOF'
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Rozitech - Innovative SaaS Platform Solutions</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
                    .hero {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        text-align: center;
                        padding: 20px;
                    }
                    .hero-content { max-width: 900px; }
                    h1 { font-size: 3.5rem; margin-bottom: 1.5rem; font-weight: 700; }
                    p { font-size: 1.35rem; margin-bottom: 2.5rem; opacity: 0.95; line-height: 1.6; }
                    .buttons { display: flex; gap: 1.2rem; justify-content: center; flex-wrap: wrap; }
                    .btn {
                        padding: 1.1rem 2.5rem;
                        border-radius: 50px;
                        text-decoration: none;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        cursor: pointer;
                        font-size: 1.1rem;
                    }
                    .btn:hover { 
                        transform: translateY(-3px);
                        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    }
                    .btn-primary {
                        background: white;
                        color: #667eea;
                    }
                    .btn-primary:hover {
                        background: #f8f8f8;
                    }
                    .btn-secondary {
                        border: 2px solid white;
                        color: white;
                        background: transparent;
                    }
                    .btn-secondary:hover {
                        background: rgba(255,255,255,0.1);
                    }
                </style>
            </head>
            <body>
                <div class="hero">
                    <div class="hero-content">
                        <h1>Innovative SaaS Platform Solutions</h1>
                        <p>Empower your business with Rozitech's next-generation multi-tenant architecture. Designed for scalability, optimized for the African market, trusted by industry leaders.</p>
                        <div class="buttons">
                            <a href="contact.html" class="btn btn-primary">Start Your Journey</a>
                            <a href="about.html" class="btn btn-secondary">Discover More</a>
                        </div>
                    </div>
                </div>
            </body>
            </html>
            EOF
            
            # Create contact.html
            cat > contact.html << 'EOF'
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Contact Us - Rozitech</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { 
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    }
                    .container {
                        background: white;
                        border-radius: 20px;
                        padding: 3rem;
                        max-width: 600px;
                        width: 100%;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    }
                    h1 { color: #333; margin-bottom: 1.5rem; }
                    p { color: #666; margin-bottom: 2rem; line-height: 1.6; }
                    .contact-info { margin: 2rem 0; }
                    .contact-item { margin: 1rem 0; color: #555; }
                    .back-link {
                        display: inline-block;
                        margin-top: 2rem;
                        color: #667eea;
                        text-decoration: none;
                        font-weight: 600;
                    }
                    .back-link:hover { text-decoration: underline; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>Get in Touch</h1>
                    <p>Ready to transform your business? Our team is here to help you get started with Rozitech's enterprise solutions.</p>
                    <div class="contact-info">
                        <div class="contact-item">üìß Email: hello@rozitech.com</div>
                        <div class="contact-item">üì± Phone: +27 (0) 21 555 0123</div>
                        <div class="contact-item">üìç Location: Cape Town, South Africa</div>
                    </div>
                    <p>We typically respond within 24 hours during business days.</p>
                    <a href="index.html" class="back-link">‚Üê Back to Home</a>
                </div>
            </body>
            </html>
            EOF
            
            # Create about.html
            cat > about.html << 'EOF'
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>About Rozitech - Our Mission</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { 
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    }
                    .container {
                        background: white;
                        border-radius: 20px;
                        padding: 3rem;
                        max-width: 700px;
                        width: 100%;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    }
                    h1 { color: #333; margin-bottom: 1.5rem; }
                    h2 { color: #555; margin: 2rem 0 1rem; font-size: 1.3rem; }
                    p { color: #666; margin-bottom: 1.5rem; line-height: 1.7; }
                    .features {
                        display: grid;
                        gap: 1rem;
                        margin: 2rem 0;
                    }
                    .feature {
                        padding: 1rem;
                        background: #f8f9fa;
                        border-radius: 10px;
                        border-left: 4px solid #667eea;
                    }
                    .back-link {
                        display: inline-block;
                        margin-top: 2rem;
                        color: #667eea;
                        text-decoration: none;
                        font-weight: 600;
                    }
                    .back-link:hover { text-decoration: underline; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>About Rozitech</h1>
                    <p>Founded with a vision to revolutionize business operations across Africa, Rozitech delivers cutting-edge SaaS solutions that empower organizations to scale efficiently and securely.</p>
                    
                    <h2>Our Mission</h2>
                    <p>To provide world-class, locally-optimized software solutions that enable African businesses to compete on a global stage while addressing unique regional requirements.</p>
                    
                    <h2>What Sets Us Apart</h2>
                    <div class="features">
                        <div class="feature">
                            <strong>üöÄ Multi-Tenant Architecture</strong><br>
                            Efficient resource utilization with complete data isolation
                        </div>
                        <div class="feature">
                            <strong>üîí Enterprise Security</strong><br>
                            POPIA compliant with end-to-end encryption
                        </div>
                        <div class="feature">
                            <strong>üìà Infinite Scalability</strong><br>
                            Auto-scaling infrastructure that grows with your needs
                        </div>
                        <div class="feature">
                            <strong>üåç Africa-Focused</strong><br>
                            Built for African markets with local payment integration
                        </div>
                    </div>
                    
                    <a href="index.html" class="back-link">‚Üê Back to Home</a>
                </div>
            </body>
            </html>
            EOF
            
            echo "‚úÖ Website files created"
            
            # Deploy files with force overwrite
            echo "Deploying files to $WEB_ROOT..."
            if [ -w "$WEB_ROOT" ]; then
              # We have write permission
              cp -f *.html "$WEB_ROOT/"
              echo "‚úÖ Files deployed (user permissions)"
            elif sudo -n true 2>/dev/null; then
              # We can use sudo
              sudo cp -f *.html "$WEB_ROOT/"
              sudo chmod 644 "$WEB_ROOT"/*.html
              echo "‚úÖ Files deployed (sudo permissions)"
            else
              # Try without sudo first
              cp -f *.html "$WEB_ROOT/" 2>/dev/null || {
                echo "‚ùå Deployment failed - no write permissions"
                exit 1
              }
            fi
            
            # Verify deployment
            echo "Verifying deployment..."
            if [ -f "$WEB_ROOT/index.html" ]; then
              echo "‚úÖ index.html deployed successfully"
              echo "File size: $(wc -c < "$WEB_ROOT/index.html") bytes"
              echo "First line of deployed file:"
              head -n 1 "$WEB_ROOT/index.html"
            fi
            
            # Clear any server cache if possible
            if command -v sync &> /dev/null; then
              sync
              echo "‚úÖ File system synced"
            fi
            
            # Cleanup
            rm -rf "$TEMP_DIR"
            
            echo "üéâ Deployment Complete!"
            echo "üìå Files deployed to: $WEB_ROOT"
            echo "üìå Please clear your browser cache if you don't see changes"