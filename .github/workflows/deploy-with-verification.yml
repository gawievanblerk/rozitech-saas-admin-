name: Deploy with Verification

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'website_pages/**'
      - '.github/workflows/deploy-with-verification.yml'

jobs:
  verify-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add known hosts if provided
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
          fi
      
      - name: Verify SSH Connection
        run: |
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.SSH_PORT || '22' }} \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
              "echo 'SSH connection successful'"
          
          if [ $? -eq 0 ]; then
            echo "✅ SSH connection verified"
          else
            echo "❌ SSH connection failed"
            exit 1
          fi
      
      - name: Deploy Website Files
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          timeout: 60s
          script: |
            echo "🚀 Starting Website Deployment..."
            
            # First, let's discover the directory structure
            echo "📂 Discovering directory structure..."
            echo "Current user: $(whoami)"
            echo "Home directory: $HOME"
            
            # Check common Xneelo/cPanel paths
            echo "Checking for web directories..."
            
            # List current home directory contents
            echo "Current home directory contents:"
            ls -la $HOME
            
            # The actual web root for Rozitech is /opt/rozitech-website
            WEB_ROOT="/opt/rozitech-website"
            
            # Check if we can access the web root
            if [ -d "$WEB_ROOT" ]; then
              echo "✅ Found Rozitech website directory: $WEB_ROOT"
              
              # Check if it's inside a Docker container setup
              if [ -f "/opt/rozitech-saas/locations.conf" ]; then
                echo "✅ Detected Docker/Nginx setup with locations.conf"
                echo "📝 Nginx is serving from: $WEB_ROOT"
              fi
            else
              echo "❌ Cannot find website directory at $WEB_ROOT"
              echo "Checking alternative locations..."
              
              # Fall back to public_html if /opt/rozitech-website doesn't exist
              if [ -d "$HOME/public_html" ]; then
                echo "⚠️ Using fallback: $HOME/public_html"
                WEB_ROOT="$HOME/public_html"
              else
                echo "Creating $HOME/public_html as fallback..."
                mkdir -p "$HOME/public_html"
                WEB_ROOT="$HOME/public_html"
              fi
            fi
            
            echo "📂 Using web root: $WEB_ROOT"
            
            # Check what's currently in the web root
            echo "Current files in web root:"
            ls -la "$WEB_ROOT" | head -20
            
            # Check for other potential web directories
            echo ""
            echo "🔍 Checking for other web directories..."
            
            # Check if there's a domains directory (common in cPanel/Xneelo)
            if [ -d "$HOME/domains" ]; then
              echo "Found domains directory:"
              ls -la "$HOME/domains"
              
              # Check each domain folder
              for domain in $HOME/domains/*/; do
                if [ -d "$domain" ]; then
                  echo "Domain: $domain"
                  if [ -d "$domain/public_html" ]; then
                    echo "  → Has public_html:"
                    ls -la "$domain/public_html" | head -5
                  fi
                fi
              done
            fi
            
            # Check for www directory
            if [ -d "$HOME/www" ] && [ "$WEB_ROOT" != "$HOME/www" ]; then
              echo "Found www directory:"
              ls -la "$HOME/www" | head -5
            fi
            
            # Check Apache/Nginx config if accessible
            if [ -f "/etc/apache2/sites-enabled/000-default.conf" ]; then
              echo "Apache config DocumentRoot:"
              grep -i documentroot /etc/apache2/sites-enabled/000-default.conf 2>/dev/null | head -2
            fi
            
            # Check if there's a symbolic link
            if [ -L "$HOME/public_html" ]; then
              echo "⚠️ public_html is a symbolic link pointing to:"
              readlink -f "$HOME/public_html"
            fi
            
            # Find all index.html files in home directory
            echo ""
            echo "🔍 Finding all index.html files:"
            find $HOME -name "index.html" -type f 2>/dev/null | head -10
            
            # Backup existing index.html if it exists
            if [ -f "$WEB_ROOT/index.html" ]; then
              echo "📦 Backing up existing index.html"
              cp "$WEB_ROOT/index.html" "$WEB_ROOT/index.html.backup.$(date +%s)"
            fi
            
            # Create temp directory
            TEMP_DIR="/tmp/rozitech-deploy-$(date +%s)"
            mkdir -p "$TEMP_DIR"
            cd "$TEMP_DIR"
            
            # Create index.html - Complete Homepage
            cat > index.html << 'EOF'
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Rozitech - Enterprise SaaS Solutions for Africa</title>
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; color: #333; }
                    
                    /* Navigation */
                    .navbar { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 1rem 0; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
                    .nav-container { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 2rem; }
                    .nav-logo h2 { color: #667eea; font-size: 1.8rem; }
                    .nav-menu { display: flex; gap: 2rem; }
                    .nav-link { text-decoration: none; color: #333; font-weight: 500; transition: color 0.3s; }
                    .nav-link:hover { color: #667eea; }
                    .nav-cta { background: #667eea; color: white; padding: 0.7rem 1.5rem; border-radius: 25px; text-decoration: none; font-weight: 600; transition: all 0.3s; }
                    .nav-cta:hover { background: #5a6fd8; transform: translateY(-2px); }
                    
                    /* Hero Section */
                    .hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; min-height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; padding: 120px 20px 80px; }
                    .hero-content { max-width: 800px; }
                    .hero h1 { font-size: 3.5rem; margin-bottom: 1.5rem; font-weight: 700; }
                    .hero p { font-size: 1.3rem; margin-bottom: 2.5rem; opacity: 0.95; }
                    .hero-buttons { display: flex; gap: 1.5rem; justify-content: center; flex-wrap: wrap; }
                    .btn { padding: 1.2rem 2.5rem; border-radius: 50px; text-decoration: none; font-weight: 600; transition: all 0.3s ease; font-size: 1.1rem; }
                    .btn-primary { background: white; color: #667eea; }
                    .btn-primary:hover { background: #f8f8f8; transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
                    .btn-secondary { border: 2px solid white; color: white; background: transparent; }
                    .btn-secondary:hover { background: rgba(255,255,255,0.1); transform: translateY(-3px); }
                    
                    /* Features Section */
                    .features { padding: 80px 20px; background: #f8f9fa; }
                    .container { max-width: 1200px; margin: 0 auto; }
                    .section-title { text-align: center; margin-bottom: 60px; }
                    .section-title h2 { font-size: 2.5rem; margin-bottom: 1rem; color: #333; }
                    .section-title p { font-size: 1.2rem; color: #666; }
                    .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 40px; }
                    .feature-card { background: white; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.1); transition: transform 0.3s; }
                    .feature-card:hover { transform: translateY(-10px); }
                    .feature-icon { font-size: 3rem; color: #667eea; margin-bottom: 1.5rem; }
                    .feature-card h3 { font-size: 1.5rem; margin-bottom: 1rem; color: #333; }
                    .feature-card p { color: #666; }
                    
                    /* Products Preview */
                    .products-preview { padding: 80px 20px; }
                    .products-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 40px; margin-top: 60px; }
                    .product-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; text-align: center; }
                    .product-card h3 { font-size: 2rem; margin-bottom: 1rem; }
                    .product-card p { margin-bottom: 2rem; opacity: 0.9; }
                    .product-card .btn { background: rgba(255,255,255,0.2); border: 2px solid white; color: white; }
                    .product-card .btn:hover { background: white; color: #667eea; }
                    
                    /* CTA Section */
                    .cta-section { background: #333; color: white; padding: 80px 20px; text-align: center; }
                    .cta-section h2 { font-size: 2.5rem; margin-bottom: 1rem; }
                    .cta-section p { font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9; }
                    
                    /* Footer */
                    .footer { background: #222; color: white; padding: 60px 20px 20px; }
                    .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 40px; margin-bottom: 40px; }
                    .footer-section h3 { margin-bottom: 1rem; color: #667eea; }
                    .footer-section p, .footer-section a { color: #ccc; text-decoration: none; }
                    .footer-section a:hover { color: white; }
                    .footer-bottom { text-align: center; padding-top: 20px; border-top: 1px solid #444; color: #999; }
                    
                    /* Mobile Responsive */
                    @media (max-width: 768px) {
                        .nav-menu { display: none; }
                        .hero h1 { font-size: 2.5rem; }
                        .hero-buttons { flex-direction: column; align-items: center; }
                        .btn { width: 100%; max-width: 300px; }
                        .products-grid { grid-template-columns: 1fr; }
                    }
                </style>
            </head>
            <body>
                <!-- Navigation -->
                <nav class="navbar">
                    <div class="nav-container">
                        <div class="nav-logo">
                            <h2><i class="fas fa-rocket"></i> Rozitech</h2>
                        </div>
                        <div class="nav-menu">
                            <a href="#home" class="nav-link">Home</a>
                            <a href="products.html" class="nav-link">Products</a>
                            <a href="pricing.html" class="nav-link">Pricing</a>
                            <a href="about.html" class="nav-link">About</a>
                            <a href="contact.html" class="nav-link">Contact</a>
                        </div>
                        <a href="app.html" class="nav-cta">Access Platform</a>
                    </div>
                </nav>
            
                <!-- Hero Section -->
                <section id="home" class="hero">
                    <div class="hero-content">
                        <h1>Enterprise SaaS Solutions for Modern Africa</h1>
                        <p>Transform your business with Rozitech's cutting-edge multi-tenant platforms. Built for scale, designed for Africa, trusted by industry leaders across the continent.</p>
                        <div class="hero-buttons">
                            <a href="contact.html" class="btn btn-primary">Start Your Journey</a>
                            <a href="products.html" class="btn btn-secondary">Explore Products</a>
                        </div>
                    </div>
                </section>
            
                <!-- Features Section -->
                <section class="features">
                    <div class="container">
                        <div class="section-title">
                            <h2>Why Choose Rozitech?</h2>
                            <p>Comprehensive SaaS solutions designed specifically for African businesses</p>
                        </div>
                        <div class="features-grid">
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-shield-alt"></i></div>
                                <h3>Enterprise Security</h3>
                                <p>Bank-grade security with end-to-end encryption, POPIA compliance, and SOC 2 certification for complete data protection.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-expand-arrows-alt"></i></div>
                                <h3>Infinite Scalability</h3>
                                <p>Auto-scaling cloud infrastructure that grows with your business. Handle millions of users without performance degradation.</p>
                            </div>
                            <div class="feature-card">
                                <div class="feature-icon"><i class="fas fa-users"></i></div>
                                <h3>Multi-Tenant Architecture</h3>
                                <p>Efficient resource utilization with complete tenant isolation. Shared infrastructure, isolated data environments.</p>
                            </div>
                        </div>
                    </div>
                </section>
            
                <!-- Products Preview -->
                <section class="products-preview">
                    <div class="container">
                        <div class="section-title">
                            <h2>Our Platform Solutions</h2>
                            <p>Comprehensive software solutions for every industry</p>
                        </div>
                        <div class="products-grid">
                            <div class="product-card">
                                <h3><i class="fas fa-heart"></i> Insurr Platform</h3>
                                <p>Complete insurance management solution for funeral and life insurance companies. Policy lifecycle, claims processing, and regulatory compliance.</p>
                                <a href="products.html#insurr" class="btn">Learn More</a>
                            </div>
                            <div class="product-card">
                                <h3><i class="fas fa-cogs"></i> Custom SaaS</h3>
                                <p>Tailored multi-tenant platforms for your specific industry. Built on our proven architecture with your unique business logic.</p>
                                <a href="contact.html" class="btn">Get Started</a>
                            </div>
                        </div>
                    </div>
                </section>
            
                <!-- CTA Section -->
                <section class="cta-section">
                    <div class="container">
                        <h2>Ready to Transform Your Business?</h2>
                        <p>Join hundreds of companies across Africa who trust Rozitech for their digital transformation</p>
                        <a href="contact.html" class="btn btn-primary">Get Started Today</a>
                    </div>
                </section>
            
                <!-- Footer -->
                <footer class="footer">
                    <div class="container">
                        <div class="footer-content">
                            <div class="footer-section">
                                <h3>Rozitech</h3>
                                <p>Leading SaaS platform provider for African businesses. Innovative solutions, reliable technology, exceptional support.</p>
                            </div>
                            <div class="footer-section">
                                <h3>Products</h3>
                                <p><a href="products.html">Insurr Platform</a></p>
                                <p><a href="products.html">Custom SaaS</a></p>
                                <p><a href="pricing.html">Pricing Plans</a></p>
                            </div>
                            <div class="footer-section">
                                <h3>Company</h3>
                                <p><a href="about.html">About Us</a></p>
                                <p><a href="contact.html">Contact</a></p>
                                <p><a href="#careers">Careers</a></p>
                            </div>
                            <div class="footer-section">
                                <h3>Contact</h3>
                                <p>📍 Cape Town, South Africa</p>
                                <p>📧 hello@rozitech.com</p>
                                <p>📱 +27 (0) 21 555 0123</p>
                            </div>
                        </div>
                        <div class="footer-bottom">
                            <p>&copy; 2024 Rozitech. All rights reserved. | Built for African Innovation</p>
                        </div>
                    </div>
                </footer>
            </body>
            </html>
            EOF
            
            # Create contact.html
            cat > contact.html << 'EOF'
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Contact Us - Rozitech</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { 
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    }
                    .container {
                        background: white;
                        border-radius: 20px;
                        padding: 3rem;
                        max-width: 600px;
                        width: 100%;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    }
                    h1 { color: #333; margin-bottom: 1.5rem; }
                    p { color: #666; margin-bottom: 2rem; line-height: 1.6; }
                    .contact-info { margin: 2rem 0; }
                    .contact-item { margin: 1rem 0; color: #555; }
                    .back-link {
                        display: inline-block;
                        margin-top: 2rem;
                        color: #667eea;
                        text-decoration: none;
                        font-weight: 600;
                    }
                    .back-link:hover { text-decoration: underline; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>Get in Touch</h1>
                    <p>Ready to transform your business? Our team is here to help you get started with Rozitech's enterprise solutions.</p>
                    <div class="contact-info">
                        <div class="contact-item">📧 Email: hello@rozitech.com</div>
                        <div class="contact-item">📱 Phone: +27 (0) 21 555 0123</div>
                        <div class="contact-item">📍 Location: Cape Town, South Africa</div>
                    </div>
                    <p>We typically respond within 24 hours during business days.</p>
                    <a href="index.html" class="back-link">← Back to Home</a>
                </div>
            </body>
            </html>
            EOF
            
            # Create about.html
            cat > about.html << 'EOF'
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>About Rozitech - Our Mission</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { 
                        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        padding: 20px;
                    }
                    .container {
                        background: white;
                        border-radius: 20px;
                        padding: 3rem;
                        max-width: 700px;
                        width: 100%;
                        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    }
                    h1 { color: #333; margin-bottom: 1.5rem; }
                    h2 { color: #555; margin: 2rem 0 1rem; font-size: 1.3rem; }
                    p { color: #666; margin-bottom: 1.5rem; line-height: 1.7; }
                    .features {
                        display: grid;
                        gap: 1rem;
                        margin: 2rem 0;
                    }
                    .feature {
                        padding: 1rem;
                        background: #f8f9fa;
                        border-radius: 10px;
                        border-left: 4px solid #667eea;
                    }
                    .back-link {
                        display: inline-block;
                        margin-top: 2rem;
                        color: #667eea;
                        text-decoration: none;
                        font-weight: 600;
                    }
                    .back-link:hover { text-decoration: underline; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>About Rozitech</h1>
                    <p>Founded with a vision to revolutionize business operations across Africa, Rozitech delivers cutting-edge SaaS solutions that empower organizations to scale efficiently and securely.</p>
                    
                    <h2>Our Mission</h2>
                    <p>To provide world-class, locally-optimized software solutions that enable African businesses to compete on a global stage while addressing unique regional requirements.</p>
                    
                    <h2>What Sets Us Apart</h2>
                    <div class="features">
                        <div class="feature">
                            <strong>🚀 Multi-Tenant Architecture</strong><br>
                            Efficient resource utilization with complete data isolation
                        </div>
                        <div class="feature">
                            <strong>🔒 Enterprise Security</strong><br>
                            POPIA compliant with end-to-end encryption
                        </div>
                        <div class="feature">
                            <strong>📈 Infinite Scalability</strong><br>
                            Auto-scaling infrastructure that grows with your needs
                        </div>
                        <div class="feature">
                            <strong>🌍 Africa-Focused</strong><br>
                            Built for African markets with local payment integration
                        </div>
                    </div>
                    
                    <a href="index.html" class="back-link">← Back to Home</a>
                </div>
            </body>
            </html>
            EOF
            
            echo "✅ Website files created"
            
            # Deploy files with force overwrite
            echo "Deploying files to $WEB_ROOT..."
            
            # For /opt/rozitech-website, we need sudo
            if [ "$WEB_ROOT" = "/opt/rozitech-website" ]; then
              echo "📝 Deploying to production website directory (requires sudo)..."
              
              # Backup existing files
              sudo cp "$WEB_ROOT/index.html" "$WEB_ROOT/index.html.backup.$(date +%s)" 2>/dev/null || true
              
              # Deploy new files
              sudo cp -f *.html "$WEB_ROOT/"
              sudo chmod 644 "$WEB_ROOT"/*.html
              echo "✅ Files deployed to production with sudo"
              
              # Reload nginx to ensure changes are picked up
              echo "🔄 Reloading nginx container..."
              sudo docker exec rozitech-live nginx -s reload 2>/dev/null || echo "⚠️ Could not reload nginx (may not be needed)"
            elif [ -w "$WEB_ROOT" ]; then
              # We have write permission
              cp -f *.html "$WEB_ROOT/"
              echo "✅ Files deployed (user permissions)"
            else
              # Try with sudo as fallback
              sudo cp -f *.html "$WEB_ROOT/" 2>/dev/null || {
                echo "❌ Deployment failed - no write permissions"
                exit 1
              }
              sudo chmod 644 "$WEB_ROOT"/*.html 2>/dev/null || true
              echo "✅ Files deployed (sudo permissions)"
            fi
            
            # Verify deployment
            echo "Verifying deployment..."
            if [ -f "$WEB_ROOT/index.html" ]; then
              echo "✅ index.html deployed successfully"
              echo "File size: $(wc -c < "$WEB_ROOT/index.html") bytes"
              echo "First line of deployed file:"
              head -n 1 "$WEB_ROOT/index.html"
            fi
            
            # Clear any server cache if possible
            if command -v sync &> /dev/null; then
              sync
              echo "✅ File system synced"
            fi
            
            # Cleanup
            rm -rf "$TEMP_DIR"
            
            echo "🎉 Deployment Complete!"
            echo "📌 Files deployed to: $WEB_ROOT"
            echo "📌 Please clear your browser cache if you don't see changes"