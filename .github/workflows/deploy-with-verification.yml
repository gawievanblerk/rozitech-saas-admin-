name: Deploy with Verification

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'website_pages/**'
      - '.github/workflows/deploy-with-verification.yml'

jobs:
  verify-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add known hosts if provided
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
          fi
      
      - name: Verify SSH Connection
        run: |
          echo "Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key \
              -p ${{ secrets.SSH_PORT || '22' }} \
              -o StrictHostKeyChecking=no \
              -o ConnectTimeout=10 \
              ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} \
              "echo 'SSH connection successful'"
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ SSH connection verified"
          else
            echo "‚ùå SSH connection failed"
            exit 1
          fi
      
      - name: Deploy Website Files
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          timeout: 60s
          script: |
            echo "üöÄ Starting Website Deployment..."
            
            # First, let's discover the directory structure
            echo "üìÇ Discovering directory structure..."
            echo "Current user: $(whoami)"
            echo "Home directory: $HOME"
            
            # Check common Xneelo/cPanel paths
            echo "Checking for web directories..."
            
            # List current home directory contents
            echo "Current home directory contents:"
            ls -la $HOME
            
            # Check if public_html exists, if not create it
            if [ -d "$HOME/public_html" ]; then
              echo "‚úÖ Found existing: $HOME/public_html"
              WEB_ROOT="$HOME/public_html"
            elif [ -d "$HOME/www" ]; then
              echo "‚úÖ Found existing: $HOME/www"
              WEB_ROOT="$HOME/www"
            elif [ -d "$HOME/htdocs" ]; then
              echo "‚úÖ Found existing: $HOME/htdocs"
              WEB_ROOT="$HOME/htdocs"
            else
              # Create public_html directory since it doesn't exist
              echo "üìÅ Web directory not found. Creating public_html..."
              mkdir -p "$HOME/public_html"
              if [ $? -eq 0 ]; then
                echo "‚úÖ Successfully created $HOME/public_html"
                WEB_ROOT="$HOME/public_html"
                
                # Create a simple .htaccess file for Apache
                echo "Creating .htaccess file..."
                cat > "$HOME/public_html/.htaccess" << 'HTACCESS'
            # Basic Apache configuration
            Options -Indexes
            DirectoryIndex index.html index.php
            
            # Enable compression
            <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript
            </IfModule>
            HTACCESS
                echo "‚úÖ Created .htaccess file"
              else
                echo "‚ùå Failed to create public_html directory"
                echo "Trying alternative location..."
                
                # Try creating in current directory
                mkdir -p "./www"
                if [ $? -eq 0 ]; then
                  echo "‚úÖ Created www directory in current location"
                  WEB_ROOT="$(pwd)/www"
                else
                  echo "‚ùå Could not create web directory"
                  exit 1
                fi
              fi
            fi
            
            echo "üìÇ Using web root: $WEB_ROOT"
            
            # Create temp directory
            TEMP_DIR="/tmp/rozitech-deploy-$(date +%s)"
            mkdir -p "$TEMP_DIR"
            cd "$TEMP_DIR"
            
            # Create index.html
            cat > index.html << 'EOF'
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>Rozitech - Enterprise SaaS Solutions</title>
                <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
                    .hero {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        min-height: 100vh;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        text-align: center;
                        padding: 20px;
                    }
                    .hero-content { max-width: 800px; }
                    h1 { font-size: 3.5rem; margin-bottom: 1.5rem; }
                    p { font-size: 1.25rem; margin-bottom: 2rem; opacity: 0.95; }
                    .buttons { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
                    .btn {
                        padding: 1rem 2rem;
                        border-radius: 50px;
                        text-decoration: none;
                        font-weight: 600;
                        transition: transform 0.2s;
                    }
                    .btn:hover { transform: translateY(-2px); }
                    .btn-primary {
                        background: white;
                        color: #667eea;
                    }
                    .btn-secondary {
                        border: 2px solid white;
                        color: white;
                    }
                </style>
            </head>
            <body>
                <div class="hero">
                    <div class="hero-content">
                        <h1>Enterprise SaaS Solutions</h1>
                        <p>Transform your business with our comprehensive multi-tenant platform. Built for the South African market.</p>
                        <div class="buttons">
                            <a href="#" class="btn btn-primary">Get Started</a>
                            <a href="#" class="btn btn-secondary">Learn More</a>
                        </div>
                    </div>
                </div>
            </body>
            </html>
            EOF
            
            echo "‚úÖ Website files created"
            
            # Deploy files
            if sudo cp *.html "$WEB_ROOT/" 2>/dev/null; then
              echo "‚úÖ Files deployed with sudo"
              sudo chmod 644 "$WEB_ROOT"/*.html 2>/dev/null || true
            elif cp *.html "$WEB_ROOT/" 2>/dev/null; then
              echo "‚úÖ Files deployed"
            else
              echo "‚ùå Deployment failed"
              exit 1
            fi
            
            # Cleanup
            rm -rf "$TEMP_DIR"
            
            echo "üéâ Deployment Complete!"